"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const core_1 = require("@marblejs/core");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const parsers_1 = require("./parsers");
const body_util_1 = require("./body.util");
const PARSEABLE_METHODS = ['POST', 'PUT', 'PATCH'];
exports.bodyParser$ = ({ type = ['*/*'], parser = parsers_1.defaultParser, } = {}) => req$ => req$.pipe(operators_1.switchMap(req => rxjs_1.iif(() => PARSEABLE_METHODS.includes(req.method)
    && !body_util_1.hasBody(req)
    && !body_util_1.isMultipart(req)
    && body_util_1.matchType(type)(req), rxjs_1.of(req).pipe(operators_1.mergeMap(body_util_1.getBody), operators_1.map(parser(req)), operators_1.tap(body => req.body = body), operators_1.mapTo(req), operators_1.catchError(() => rxjs_1.throwError(new core_1.HttpError('Request body parse error', core_1.HttpStatus.BAD_REQUEST)))), rxjs_1.of(req))));
